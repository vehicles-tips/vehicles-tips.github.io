import React, { useMemo, useState } from "react";
import { motion } from "framer-motion";
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Calculator, Printer, Copy, CheckCircle2, AlertTriangle, DollarSign, BadgePercent, Link as LinkIcon, Info } from "lucide-react";

// --- Helper utils -----------------------------------------------------------
const fmtMoney = (n: number) =>
  new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(
    isFinite(n) ? n : 0
  );

const clamp = (n: number, min: number, max: number) => Math.min(Math.max(n, min), max);

const genQuoteId = () => `PMQ-${Date.now().toString(36).toUpperCase()}`;

const sevenDaysFromNow = () => {
  const d = new Date();
  d.setDate(d.getDate() + 7);
  d.setHours(23, 59, 59, 0);
  return d;
};

// --- Types ------------------------------------------------------------------
interface Quote {
  id: string;
  company: string;
  productName: string;
  sku: string;
  quantity: number;
  ourPrice: number;
  competitorPrice: number;
  shippingAdj: number;
  matchedPrice: number;
  savings: number;
  competitorName: string;
  competitorUrl: string;
  expiresAt: Date;
  notes?: string;
}

// --- Main Component ---------------------------------------------------------
export default function PriceMatchQuote() {
  // Basic business settings (adjust to your policy)
  const [company, setCompany] = useState("Acme Retail Co.");
  const [maxDiscountPct, setMaxDiscountPct] = useState<number>(30); // cap relative to our price
  const [floorPrice, setFloorPrice] = useState<number>(0); // absolute floor

  // Form state
  const [productName, setProductName] = useState("");
  const [sku, setSku] = useState("");
  const [quantity, setQuantity] = useState<number>(1);
  const [ourPrice, setOurPrice] = useState<string>("");
  const [competitorPrice, setCompetitorPrice] = useState<string>("");
  const [shippingAdj, setShippingAdj] = useState<string>("0"); // +shipping if competitor charges shipping, negative if we do
  const [competitorName, setCompetitorName] = useState("");
  const [competitorUrl, setCompetitorUrl] = useState("");
  const [taxRate, setTaxRate] = useState<string>("0"); // optional, local sales tax % for preview
  const [notes, setNotes] = useState<string>("");

  // Eligibility checklist (adjust to your policy)
  const [identicalModel, setIdenticalModel] = useState(true);
  const [inStock, setInStock] = useState(true);
  const [authorizedSeller, setAuthorizedSeller] = useState(true);
  const [notMarketplace, setNotMarketplace] = useState(true); // not auction/marketplace/membership-only
  const [notClearance, setNotClearance] = useState(true); // no clearance/open-box/refurb

  const parsed = useMemo(() => {
    const our = parseFloat(ourPrice) || 0;
    const comp = parseFloat(competitorPrice) || 0;
    const ship = parseFloat(shippingAdj || "0") || 0;
    const tax = (parseFloat(taxRate || "0") || 0) / 100;
    return { our, comp, ship, tax };
  }, [ourPrice, competitorPrice, shippingAdj, taxRate]);

  const eligible = identicalModel && inStock && authorizedSeller && notMarketplace && notClearance;

  // Core calculation — simple, transparent rules
  const { matchedPriceEach, reason } = useMemo(() => {
    const { our, comp, ship } = parsed;

    if (!eligible) return { matchedPriceEach: our, reason: "Not eligible under current policy" };

    // Effective competitor price includes shipping adj if desired
    const effectiveComp = Math.max(0, comp + ship);
    // Baseline match: lower of our price and effective competitor price
    let candidate = Math.min(our, effectiveComp);

    // Apply business guardrails
    const minAllowedByPercent = our * (1 - clamp(maxDiscountPct, 0, 95) / 100);
    candidate = Math.max(candidate, minAllowedByPercent);
    candidate = Math.max(candidate, Math.max(0, floorPrice));

    const why: string[] = [];
    if (effectiveComp < our) why.push("Matched competitor's lower price");
    if (candidate === minAllowedByPercent) why.push(`Capped by ${maxDiscountPct}% max discount`);
    if (candidate === Math.max(0, floorPrice) && floorPrice > 0) why.push("Raised to floor price");
    if (why.length === 0) why.push("Our price already beats competitor");

    return { matchedPriceEach: candidate, reason: why.join(" · ") };
  }, [parsed, eligible, maxDiscountPct, floorPrice]);

  const quote: Quote | null = useMemo(() => {
    const { our, comp, ship } = parsed;
    if (!productName || our <= 0 || quantity <= 0) return null;

    const each = matchedPriceEach;
    const total = each * quantity;
    const baseTotal = our * quantity;

    return {
      id: genQuoteId(),
      company,
      productName,
      sku,
      quantity,
      ourPrice: our,
      competitorPrice: comp,
      shippingAdj: ship,
      matchedPrice: each,
      savings: Math.max(0, baseTotal - total),
      competitorName,
      competitorUrl,
      expiresAt: sevenDaysFromNow(),
      notes,
    };
  }, [company, productName, sku, quantity, parsed, matchedPriceEach, competitorName, competitorUrl, notes]);

  const [lockedQuote, setLockedQuote] = useState<Quote | null>(null);

  const lockQuote = () => {
    if (!eligible) return;
    if (quote) setLockedQuote(quote);
  };

  const copyQuote = async () => {
    const q = lockedQuote ?? quote;
    if (!q) return;
    const lines = [
      `${q.company} — Price Match Quote (${q.id})`,
      `Product: ${q.productName}${q.sku ? ` (SKU: ${q.sku})` : ""}`,
      `Qty: ${q.quantity}`,
      `Our price each: ${fmtMoney(q.ourPrice)}`,
      `Competitor price each: ${fmtMoney(q.competitorPrice)}${q.shippingAdj ? ` (shipping adj ${fmtMoney(q.shippingAdj)})` : ""}`,
      `Matched price each: ${fmtMoney(q.matchedPrice)}`,
      `Subtotal: ${fmtMoney(q.matchedPrice * q.quantity)}`,
      `Estimated tax (${(parsed.tax * 100).toFixed(2)}%): ${fmtMoney(q.matchedPrice * q.quantity * parsed.tax)}`,
      `Total est.: ${fmtMoney(q.matchedPrice * q.quantity * (1 + parsed.tax))}`,
      `Savings vs. our base: ${fmtMoney(q.savings)}`,
      `Competitor: ${q.competitorName || "—"}${q.competitorUrl ? ` — ${q.competitorUrl}` : ""}`,
      `Expires: ${q.expiresAt.toLocaleString()}`,
      q.notes ? `Notes: ${q.notes}` : "",
    ].filter(Boolean);

    try {
      await navigator.clipboard.writeText(lines.join("\n"));
    } catch {
      // no-op
    }
  };

  const printAreaId = "pmq-print";

  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-slate-50 p-4 md:p-8">
      <div className="mx-auto max-w-6xl space-y-6">
        <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }}>
          <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
            <div>
              <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Price Match Quote</h1>
              <p className="text-slate-600 mt-1">Generate a customer-ready quote under your Price Match Guarantee policy.</p>
            </div>
            <div className="flex items-center gap-2">
              <Input className="w-52" value={company} onChange={(e) => setCompany(e.target.value)} placeholder="Company name" />
              <Badge variant="secondary">Live Preview</Badge>
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Left: Form */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Calculator className="h-5 w-5" /> Quote Inputs
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-5">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Product name</Label>
                  <Input value={productName} onChange={(e) => setProductName(e.target.value)} placeholder="e.g., UltraWidget 3000" />
                </div>
                <div className="space-y-2">
                  <Label>SKU (optional)</Label>
                  <Input value={sku} onChange={(e) => setSku(e.target.value)} placeholder="e.g., UW-3000-BLK" />
                </div>
                <div className="space-y-2">
                  <Label>Quantity</Label>
                  <Input type="number" min={1} value={quantity} onChange={(e) => setQuantity(Number(e.target.value) || 1)} />
                </div>
                <div className="space-y-2">
                  <Label>Local tax % (optional)</Label>
                  <Input type="number" min={0} step="0.01" value={taxRate} onChange={(e) => setTaxRate(e.target.value)} placeholder="0" />
                </div>
              </div>

              <Separator />

              <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label>Our price (each)</Label>
                  <Input type="number" min={0} step="0.01" value={ourPrice} onChange={(e) => setOurPrice(e.target.value)} placeholder="0.00" />
                </div>
                <div className="space-y-2">
                  <Label>Competitor price (each)</Label>
                  <Input type="number" min={0} step="0.01" value={competitorPrice} onChange={(e) => setCompetitorPrice(e.target.value)} placeholder="0.00" />
                </div>
                <div className="space-y-2">
                  <Label>Shipping adj. (each)</Label>
                  <Input type="number" step="0.01" value={shippingAdj} onChange={(e) => setShippingAdj(e.target.value)} placeholder="0.00" />
                  <p className="text-xs text-slate-500">Include competitor shipping (+) or remove ours (−).</p>
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Competitor name (optional)</Label>
                  <Input value={competitorName} onChange={(e) => setCompetitorName(e.target.value)} placeholder="e.g., BestBuy" />
                </div>
                <div className="space-y-2">
                  <Label>Competitor product URL (optional)</Label>
                  <Input value={competitorUrl} onChange={(e) => setCompetitorUrl(e.target.value)} placeholder="https://…" />
                </div>
              </div>

              <Separator />

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="flex items-center justify-between rounded-xl border p-3">
                  <div>
                    <p className="text-sm font-medium">Identical model / configuration</p>
                    <p className="text-xs text-slate-500">Same brand, SKU, specs, and warranty.</p>
                  </div>
                  <Switch checked={identicalModel} onCheckedChange={setIdenticalModel} />
                </div>
                <div className="flex items-center justify-between rounded-xl border p-3">
                  <div>
                    <p className="text-sm font-medium">Competitor item in-stock</p>
                    <p className="text-xs text-slate-500">Available for immediate purchase.</p>
                  </div>
                  <Switch checked={inStock} onCheckedChange={setInStock} />
                </div>
                <div className="flex items-center justify-between rounded-xl border p-3">
                  <div>
                    <p className="text-sm font-medium">Authorized seller</p>
                    <p className="text-xs text-slate-500">Not gray market.</p>
                  </div>
                  <Switch checked={authorizedSeller} onCheckedChange={setAuthorizedSeller} />
                </div>
                <div className="flex items-center justify-between rounded-xl border p-3">
                  <div>
                    <p className="text-sm font-medium">Not marketplace/auction</p>
                    <p className="text-xs text-slate-500">Excludes membership-only or peer listings.</p>
                  </div>
                  <Switch checked={notMarketplace} onCheckedChange={setNotMarketplace} />
                </div>
                <div className="flex items-center justify-between rounded-xl border p-3">
                  <div>
                    <p className="text-sm font-medium">Not clearance/open-box/refurb</p>
                    <p className="text-xs text-slate-500">New, sealed items only.</p>
                  </div>
                  <Switch checked={notClearance} onCheckedChange={setNotClearance} />
                </div>
              </div>

              <Separator />

              <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label>Max discount %</Label>
                  <Input type="number" min={0} max={95} step={1} value={maxDiscountPct}
                    onChange={(e) => setMaxDiscountPct(clamp(Number(e.target.value) || 0, 0, 95))} />
                </div>
                <div className="space-y-2">
                  <Label>Absolute floor price (each)</Label>
                  <Input type="number" min={0} step="0.01" value={floorPrice}
                    onChange={(e) => setFloorPrice(Math.max(0, Number(e.target.value) || 0))} />
                </div>
                <div className="space-y-2">
                  <Label>Internal notes (optional)</Label>
                  <Textarea value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Context for your team…" />
                </div>
              </div>
            </CardContent>
            <CardFooter className="justify-between">
              <div className="flex items-center gap-2 text-sm">
                {eligible ? (
                  <span className="inline-flex items-center gap-1 text-emerald-600"><CheckCircle2 className="h-4 w-4"/> Eligible</span>
                ) : (
                  <span className="inline-flex items-center gap-1 text-amber-600"><AlertTriangle className="h-4 w-4"/> Not eligible</span>
                )}
                <span className="text-slate-500">· {reason}</span>
              </div>
              <div className="flex gap-2">
                <Button variant="secondary" onClick={copyQuote} className="gap-2"><Copy className="h-4 w-4"/>Copy</Button>
                <Button onClick={() => window.print()} className="gap-2"><Printer className="h-4 w-4"/>Print</Button>
                <Button disabled={!eligible || !quote} onClick={lockQuote} className="gap-2">
                  <BadgePercent className="h-4 w-4"/> Generate Quote
                </Button>
              </div>
            </CardFooter>
          </Card>

          {/* Right: Preview */}
          <Card id={printAreaId} className="relative overflow-hidden">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <DollarSign className="h-5 w-5" /> Quote Preview
              </CardTitle>
            </CardHeader>
            <CardContent>
              {!quote ? (
                <div className="text-slate-500 text-sm">Enter details on the left to preview a quote.</div>
              ) : (
                <motion.div initial={{ opacity: 0.5, y: 8 }} animate={{ opacity: 1, y: 0 }} className="space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-xl font-semibold">{company}</h2>
                      <p className="text-xs text-slate-500">Price Match Guarantee — Customer Quote</p>
                    </div>
                    <div className="text-right">
                      <Badge variant="secondary">{lockedQuote ? lockedQuote.id : quote.id}</Badge>
                      <p className="text-xs text-slate-500">Expires {(
                        (lockedQuote?.expiresAt ?? quote.expiresAt).toLocaleString()
                      )}</p>
                    </div>
                  </div>

                  <div className="rounded-2xl border p-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <p className="text-xs uppercase text-slate-500">Product</p>
                      <p className="font-medium">
                        {quote.productName} {quote.sku ? <span className="text-slate-500">(SKU {quote.sku})</span> : null}
                      </p>
                    </div>
                    <div>
                      <p className="text-xs uppercase text-slate-500">Quantity</p>
                      <p className="font-medium">{quote.quantity}</p>
                    </div>
                    <div>
                      <p className="text-xs uppercase text-slate-500">Our price (each)</p>
                      <p className="font-medium">{fmtMoney(quote.ourPrice)}</p>
                    </div>
                    <div>
                      <p className="text-xs uppercase text-slate-500">Competitor (each)</p>
                      <p className="font-medium">{fmtMoney(quote.competitorPrice)}{quote.shippingAdj ? <span className="text-slate-500"> (ship adj {fmtMoney(quote.shippingAdj)})</span> : null}</p>
                      {(quote.competitorName || quote.competitorUrl) && (
                        <div className="flex items-center gap-1 text-xs text-slate-500 mt-1">
                          <LinkIcon className="h-3.5 w-3.5"/>
                          <span>
                            {quote.competitorName || "Competitor"}
                            {quote.competitorUrl ? (
                              <>
                                {" "}·{" "}
                                <a href={quote.competitorUrl} target="_blank" rel="noreferrer" className="underline">link</a>
                              </>
                            ) : null}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="rounded-2xl border p-4 bg-slate-50">
                    <div className="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
                      <div>
                        <p className="text-xs uppercase text-slate-500">Matched price (each)</p>
                        <p className="text-2xl font-semibold">{fmtMoney(lockedQuote?.matchedPrice ?? quote.matchedPrice)}</p>
                        <p className="text-xs text-slate-500">{reason}</p>
                      </div>
                      <div className="text-right space-y-1">
                        <p className="text-sm">Subtotal: <span className="font-medium">{fmtMoney((lockedQuote?.matchedPrice ?? quote.matchedPrice) * quote.quantity)}</span></p>
                        <p className="text-sm">Est. tax ({(parsed.tax*100).toFixed(2)}%): <span className="font-medium">{fmtMoney((lockedQuote?.matchedPrice ?? quote.matchedPrice) * quote.quantity * parsed.tax)}</span></p>
                        <Separator />
                        <p className="text-base">Est. total: <span className="font-semibold">{fmtMoney((lockedQuote?.matchedPrice ?? quote.matchedPrice) * quote.quantity * (1 + parsed.tax))}</span></p>
                        <p className="text-xs text-emerald-600">You save {fmtMoney(quote.savings)} vs. our base.</p>
                      </div>
                    </div>
                  </div>

                  {(notes || lockedQuote) && (
                    <div className="rounded-2xl border p-4">
                      <p className="text-xs uppercase text-slate-500 mb-1">Notes</p>
                      <p className="text-sm whitespace-pre-wrap">{notes || "—"}</p>
                    </div>
                  )}

                  <div className="rounded-2xl border p-4 print:border-none print:p-0">
                    <p className="text-xs uppercase text-slate-500 mb-2">Price Match Guarantee — Key Terms</p>
                    <ul className="list-disc pl-5 text-xs text-slate-600 space-y-1">
                      <li>Item must be identical (brand, model/SKU, specs) and in-stock at both {company} and the competitor.</li>
                      <li>Competitor must be an authorized U.S. retailer; excludes auctions, marketplace/reseller listings, membership-only pricing, and pricing errors.</li>
                      <li>Price comparison reflects required fees including shipping; taxes may vary by jurisdiction.</li>
                      <li>Excludes clearance, open-box, refurbished, used, or limited-time doorbuster promotions.</li>
                      <li>Limit one matched price per customer per item. Not combinable with other offers. Subject to verification.</li>
                      <li>Quote valid until { (lockedQuote?.expiresAt ?? quote.expiresAt).toLocaleString() } unless withdrawn due to error or policy changes.</li>
                    </ul>
                    <div className="mt-3 flex items-start gap-2 text-[11px] text-slate-500">
                      <Info className="h-3.5 w-3.5 mt-0.5"/>
                      <p>This sample UI implements common industry rules. Customize to your official policy and consult your legal team before use.</p>
                    </div>
                  </div>
                </motion.div>
              )}
            </CardContent>
          </Card>
        </div>
      </div>

      <style>{`
        @media print {
          body { background: white; }
          #${printAreaId} { box-shadow: none; border: none; }
          button, input, textarea, .shrink-on-print { display: none !important; }
        }
      `}</style>
    </div>
  );
}

